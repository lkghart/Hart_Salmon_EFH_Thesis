---
title: "Preliminary BASIS Figures"
author: "Lilian Hart"
date: "08/05/2021"
output:
  pdf_document:
    toc: yes
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: no
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
---

```{r setup, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=TRUE, warning=TRUE)
options(scipen=1, digits=4)
# options(width=50, width.cutoff=50, digits = 6) 
require(knitr)
require(tidyverse)
require(dplyr)
require(here)
require(viridis)
require(pander)
require(kableExtra)
require(mgcv)
# require(equatiomatic)
require(visreg)
require(ggmap)

dirData <- here("data", "BASIS")

catch <- read.csv(paste0(dirData,"/Catch.csv"))
full_data <- readRDS(paste0(dirData,"/full_basis_combo_data"))
positive_join <- readRDS(paste0(dirData,"/join_basis_mld"))
mld <- read.csv(paste0(dirData,"/MLD.csv"))

full_data$cpueNum <- full_data$TotalCatchNum / full_data$Effort_area_km2
full_data$cpueWt <-  full_data$TotalCatchNum / full_data$Effort_area_km2
positive_join$cpueNum <- positive_join$TotalCatchNum / positive_join$Effort_area_km2
positive_join$cpueWt <-  positive_join$TotalCatchNum / positive_join$Effort_area_km2

# Establishing positive records for logCPUE and GAM compatibility later
positives <- positive_join %>% filter(cpueWt > 0)

justSalmon <- subset(full_data, full_data$CommonName != "Pollock")
pollock <- subset(full_data, full_data$CommonName == "Pollock")
sockeye <- subset(full_data, full_data$CommonName == "Sockeye Salmon")
chum <- subset(full_data, full_data$CommonName == "Chum Salmon")
coho <- subset(full_data, full_data$CommonName == "Coho Salmon")
chinook <- subset(full_data, full_data$CommonName == "Chinook Salmon")
pink <- subset(full_data, full_data$CommonName == "Pink Salmon")

left <- min(full_data$EQ.Longitude, na.rm=TRUE)
right <- max(full_data$EQ.Longitude, na.rm=TRUE)
bottom <- min(full_data$EQ.Latitude, na.rm=TRUE)
top <- max(full_data$EQ.Latitude, na.rm=TRUE)

map.dat <- get_map(location=c(left, bottom,
                              right, top),
                   maptype='toner-lite', source='stamen', crop=TRUE)
```

# Histograms 

## Histograms of catch by number 
```{r histograms, echo = FALSE}
hist(pollock$TotalCatchNum, xlab = "Catch Number per Event",
     main = "Histogram of Pollock Catch Numbers", xlim=c(0,150000))

#The BASIS survey collected a greater number of pollock individuals at each survey event than salmon.

hist(sockeye$TotalCatchNum, xlab = "Catch Number per Event",
     main = "Histogram of Sockeye Salmon Catch Numbers", xlim=c(0,600))

hist(chum$TotalCatchNum, xlab = "Catch Number per Event",
     main = "Histogram of Chum Salmon Catch Numbers", xlim=c(0,600))

hist(coho$TotalCatchNum, xlab = "Catch Number per Event", xlim=c(0,150),
     main = "Histogram of Coho Salmon Catch Numbers")

hist(chinook$TotalCatchNum, xlab = "Catch Number per Event",
     main = "Histogram of Chinook Salmon Catch Numbers", xlim=c(0,80))

hist(pink$TotalCatchNum, xlab = "Catch Number per Event",
     main = "Histogram of Pink Salmon Catch Numbers", xlim=c(0,1500))
```

## Histograms of Catch Per Unit Effort (CPUE) by weight

```{r cpue-hist, echo=FALSE}
hist(pollock$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Pollock CPUE by weight")

hist(sockeye$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Sockeye salmon CPUE by weight")

hist(chum$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Chum salmon CPUE by weight")

hist(coho$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Coho salmon CPUE by weight")

hist(chinook$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Chinook salmon CPUE by weight")

hist(pink$cpueWt, xlab = "CPUE by weight",
     main = "Histogram of Pink salmon CPUE by weight")
```

## Histograms of Environmental Conditions

```{r hist-enviro, echo=FALSE}
hist(mld$MeanTemp, xlab = "degrees C",
     main = "Histogram of mean temperature across all years")

hist(mld$MeanSal, xlab = "PSU",
     main = "Histogram of mean salinity for whole water column")

hist(mld$MixedLayerDepth, xlab = "meters",
     main = "Histogram of pycnocline depth in meters")

hist(mld$surfacetemp, xlab = "degrees C",
     main = "Histogram of temp above pycnocline")

hist(mld$bottomtemp, xlab = "degrees C",
     main = "Histogram of temp below pycnocline")

hist(mld$surfacesal, xlab = "PSU",
     main = "Histogram of salinity above pycnocline")

hist(mld$bottomsal, xlab = "PSUY",
     main = "Histogram of salinity below pycnocline")

```

# Bar Plots

## Plots of Catch Identity and Zero Catch proportions
```{r Catchplots}
ggplot(full_data, aes(x=CommonName, y=TotalCatchNum)) +
  geom_bar(stat="identity") +
  xlab("Species Common Name") +
  ggtitle("Alltime Total Catch Number by Species")

ggplot(justSalmon, aes(x=CommonName, y=TotalCatchNum)) +
  geom_bar(stat="identity") +
  xlab("Species Common Name") +
  ggtitle("Alltime Total Catch Number by Salmon Species")

#### Calculate Zero catch proportions ####
total_events <- 2053

# Extract number of zero catches by species
chinook_zeros <- chinook %>% filter(TotalCatchNum==0) %>% 
  nrow() # 1402 zero catches
chum_zeros <- chum %>% filter(TotalCatchNum==0) %>% 
  nrow() # 1076 
coho_zeros <- coho %>% filter(TotalCatchNum==0) %>% 
  nrow() # 1538 
pink_zeros <- pink %>% filter(TotalCatchNum==0) %>% 
  nrow() # 1162 
pollock_zeros <- pollock %>% filter(TotalCatchNum==0) %>% 
  nrow() # 883 
sockeye_zeros <- sockeye %>% filter(TotalCatchNum==0) %>% 
  nrow() # 1333 

# Calculate proportion of zero catches in each species
chinook_water_prop <- chinook_zeros/total_events #0.6829031 
# 68% of all tows had zero chinook catch
chum_water_prop <- chum_zeros/total_events #0.524111
coho_water_prop <- coho_zeros/total_events # 0.7491476
pink_water_prop <- pink_zeros/total_events #0.566001
pollock_water_prop <- pollock_zeros/total_events #0.4301023
sockeye_water_prop <- sockeye_zeros/total_events #0.6492937

# Save to dataframe
zeros_df <- data.frame("Species"=c("Chinook","Chum","Coho",
                       "Pink","Pollock","Sockeye"), 
                       "Proportions" =c(0.6829031,0.524111,0.7491476,0.566001,
                                        0.4301023,0.6492937))
ggplot(data=zeros_df, aes(x=Species, y=Proportions))+
    geom_bar(stat="identity") +
    ylab("Zero catches / All Tows")+
    ggtitle("Proportions of Zero Catches by Species")+
    ylim(0,1)

```

# Yearly Maps 

## Maps of Occurrence
```{r chinook-occurrence, echo = FALSE}
maps <- ggmap(map.dat) +
    theme_linedraw() +  
    ggtitle("Chinook Salmon Presence/Absence")+
    xlab("Longitude") +
    ylab("Latitude") +
    labs(shape = "Occurrence\n") +
     facet_wrap(~SampleYear, ncol = 6) +
    theme(legend.position = "right", axis.title=element_text(size = 20), title = 
              element_text(size = 15), legend.title = element_text(size = 15),
          legend.text = element_text(size = 12)) +
    geom_text(x=-159, y = 62, label = "Alaska", color = "white") +
    geom_text(x=-170, y = 70, label = "Chuckchi\n Sea", size = 3, color = "white") +
    geom_text(x= -172, y = 58, label = "Bering\n Sea", size = 3, color = "white") +
    scale_shape_manual(values = c(1,16), labels = c("absence", "presence")) +
     geom_point( data = chinook,
                aes(x=EQ.Longitude, y=EQ.Latitude, shape=pres_abs))
ggsave("images/PA_Maps_Chinook.png", plot = maps,  width = 10, height = 12 )

```
![Chinook salmon presence absence maps by year](images/PA_Maps_Chinook.png)
```{r chum-occurrence, echo = FALSE}
maps <- ggmap(map.dat) +
    theme_linedraw() +  
    ggtitle("Chum Salmon Presence/Absence")+
    xlab("Longitude") +
    ylab("Latitude") +
    labs(shape = "Occurrence\n") +
     facet_wrap(~SampleYear, ncol = 6) +
    theme(legend.position = "right", axis.title=element_text(size = 20), title = 
              element_text(size = 15), legend.title = element_text(size = 15),
          legend.text = element_text(size = 12)) +
    geom_text(x=-159, y = 62, label = "Alaska", color = "white") +
    geom_text(x=-170, y = 70, label = "Chuckchi\n Sea", size = 3, color = "white") +
    geom_text(x= -172, y = 58, label = "Bering\n Sea", size = 3, color = "white") +
    scale_shape_manual(values = c(1,16), labels = c("absence", "presence")) +
     geom_point( data = chum,
                aes(x=EQ.Longitude, y=EQ.Latitude, shape=pres_abs))
ggsave("images/PA_Maps_Chum.png", plot = maps,  width = 10, height = 12 )

```
![Chum salmon presence absence maps by year](images/PA_Maps_Chum.png)
```{r coho-occurrence, echo = FALSE}
maps <- ggmap(map.dat) +
    theme_linedraw() +  
    ggtitle("Coho Salmon Presence/Absence")+
    xlab("Longitude") +
    ylab("Latitude") +
    labs(shape = "Occurrence\n") +
     facet_wrap(~SampleYear, ncol = 6) +
    theme(legend.position = "right", axis.title=element_text(size = 20), title = 
              element_text(size = 15), legend.title = element_text(size = 15),
          legend.text = element_text(size = 12)) +
    geom_text(x=-159, y = 62, label = "Alaska", color = "white") +
    geom_text(x=-170, y = 70, label = "Chuckchi\n Sea", size = 3, color = "white") +
    geom_text(x= -172, y = 58, label = "Bering\n Sea", size = 3, color = "white") +
    scale_shape_manual(values = c(1,16), labels = c("absence", "presence")) +
     geom_point( data = coho,
                aes(x=EQ.Longitude, y=EQ.Latitude, shape=pres_abs))
ggsave("images/PA_Maps_Coho.png", plot = maps,  width = 10, height = 12 )


```
![Coho salmon presence absence maps by year](images/PA_Maps_Coho.png)
```{r pink-occurrence, echo = FALSE}
maps <- ggmap(map.dat) +
    theme_linedraw() +  
    ggtitle("Pink Salmon Presence/Absence")+
    xlab("Longitude") +
    ylab("Latitude") +
    labs(shape = "Occurrence\n") +
     facet_wrap(~SampleYear, ncol = 6) +
    theme(legend.position = "right", axis.title=element_text(size = 20), title = 
              element_text(size = 15), legend.title = element_text(size = 15),
          legend.text = element_text(size = 12)) +
    geom_text(x=-159, y = 62, label = "Alaska", color = "white") +
    geom_text(x=-170, y = 70, label = "Chuckchi\n Sea", size = 3, color = "white") +
    geom_text(x= -172, y = 58, label = "Bering\n Sea", size = 3, color = "white") +
    scale_shape_manual(values = c(1,16), labels = c("absence", "presence")) +
     geom_point( data = pink,
                aes(x=EQ.Longitude, y=EQ.Latitude, shape=pres_abs))
ggsave("images/PA_Maps_Pink.png", plot = maps,  width = 10, height = 12 )

```
![Pink salmon presence absence maps by year](images/PA_Maps_Pink.png)
```{r sockeye-occurrence, echo = FALSE}
maps <- ggmap(map.dat) +
    theme_linedraw() +  
    ggtitle("Sockeye Salmon Presence/Absence")+
    xlab("Longitude") +
    ylab("Latitude") +
    labs(shape = "Occurrence\n") +
     facet_wrap(~SampleYear, ncol = 6) +
    theme(legend.position = "right", axis.title=element_text(size = 20), title = 
              element_text(size = 15), legend.title = element_text(size = 15),
          legend.text = element_text(size = 12)) +
    geom_text(x=-159, y = 62, label = "Alaska", color = "white") +
    geom_text(x=-170, y = 70, label = "Chuckchi\n Sea", size = 3, color = "white") +
    geom_text(x= -172, y = 58, label = "Bering\n Sea", size = 3, color = "white") +
    scale_shape_manual(values = c(1,16), labels = c("absence", "presence")) +
     geom_point( data = sockeye,
                aes(x=EQ.Longitude, y=EQ.Latitude, shape=pres_abs))
ggsave("images/PA_Maps_Sockeye.png", plot = maps,  width = 10, height = 12 )

```
![Sockeye salmon presence absence maps by year](images/PA_Maps_Sockeye.png)

## Maps of Catch Per Unit Effort (CPUE) by Weight 
```{r cpue, echo = FALSE}

(pollock_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = pollock,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Pollock CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(sockeye_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = sockeye,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Sockeye salmon CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(chum_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = chum,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Chum salmon CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(coho_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = coho,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Coho salmon CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(chinook_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = chinook,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Chinook salmon CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(pink_cpuewt <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point( data = pink,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=log(cpueWt)), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Pink salmon CPUE by Weight") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 
```

## Maps of Environmental Conditions
```{r map-enviro}
(map_meantemp <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data = full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=MeanTemp), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Mean temperature") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()))  

(map_meansal <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=MeanSal), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Mean salinity") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()))

(map_mld <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=MixedLayerDepth), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Mixed Layer Depth") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()))  

(map_stemp <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=surfacetemp), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Temperature above pycnocline") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(map_btemp <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=bottomtemp), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Temperature below pycnocline") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(map_surfacesal <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=surfacesal), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Salinity above pycnocline") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 

(map_bottomsal <- ggmap(map.dat) +
  theme_linedraw() +  
  geom_point(data=full_data,
             aes(x=EQ.Longitude, y=EQ.Latitude, color=bottomsal), alpha=0.5) +
  facet_wrap(~SampleYear, ncol = 6) +
  ggtitle("Salinity below pycnocline") +
  scale_color_viridis() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())) 
```

# Generalized Additive Model (GAM) Plots

## GAM of log(CPUE Weight)

```{r gam-cpue}
gam_cpue <- gam(log(cpueWt) ~ s(EQ.Longitude, EQ.Latitude), data = positives)

# Plot in a 2D space for average spatial pattern
vis.gam(gam_cpue, plot.type="contour", color="topo", main="GAM log(CPUE by weight)")
# Plot GAM_1 in a 3D space for average spatial pattern
vis.gam(gam_cpue, plot.type="persp", color="topo", phi=20, theta=75)

# Check residuals
resid_gam_cpue <- resid(gam_cpue)
hist(resid_gam_cpue, xlab = "GAM CPUE by Weight Residuals", 
     main = "Histogram of residuals for GAM 1: 
     log(CPUE Weight)")
# There is a right tail to the residuals, even with log transformation
visreg(gam_cpue)
```

## GAM of surface temperature
```{r gam-temps}
gam_surfacetemp <- gam( surfacetemp ~ s(EQ.Longitude, EQ.Latitude), data = positives)

vis.gam(gam_surfacetemp, plot.type = "contour", color = "topo",
        main = "GAM Surface Temperature")

# Check residuals
resid_gam_surfacetemp <- resid(gam_surfacetemp)
hist(resid_gam_surfacetemp)

visreg(gam_surfacetemp)

```

## GAM of surface salinity
```{r gam-sal}
gam_salinity <- gam( surfacesal ~ s(EQ.Longitude, EQ.Latitude), data = positives)

vis.gam(gam_salinity, plot.type = "contour", color = "topo",
        main = "GAM Surface Salinity")

# Check residuals
resid_gam_sal <- resid(gam_salinity)
hist(resid_gam_sal)

visreg(gam_salinity)
```

## GAM of Mixed Layer Depth
```{r gam-mld}
gam_mld <- gam( MixedLayerDepth ~ s(EQ.Longitude, EQ.Latitude), data = positives)

vis.gam(gam_mld, plot.type = "contour", color = "topo",
        main = "GAM Mixed Layer Depth")

# Check residuals
resid_gam_mld <- resid(gam_mld)
hist(resid_gam_mld)

visreg(gam_mld)

```
